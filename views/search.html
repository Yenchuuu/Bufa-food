<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/search.css">
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="/icons/favicon.ico" rel="shortcut icon" type="image/ico" />
  <script src="https://kit.fontawesome.com/9d89bb6e53.js" crossorigin="anonymous"></script>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <nav style="background-color: #495464;" class="navbar navbar-expand-md navbar-dark" aria-label="Fourth navbar example">
    <div class="container-fluid">
      <a class="navbar-brand" href="/index.html"><img src="/images/bufafood_logo.png" class="brand-logo">  BUFA FOOD | ä¸ç™¼ç¦</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      </button>

      <!-- æŠŠdivçš„ class="collapse navbar-collapse justify-content-md-end" æ‹¿æ‰ï¼Œå°±å¯ä»¥é”åˆ°ç½®å³å°é½Šäº† -->
      <div id="navbarsExample04">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link active" href="/search.html">é£Ÿç‰©åº«</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled">|</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/mine.html">æˆ‘çš„é£Ÿç‰©</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled">|</a>
          </li>
          <li class="nav-item">
            <a class="active" href="/profile.html"><img src="/icons/member-mobile.png"></a>
          </li>

        </ul>
      </div>
    </div>
  </nav>
  
  <main class="d-flex flex-nowrap container-color">
  <div class="flex-shrink-0 p-3 sidebar-custom sidebar-color" style="width: 13EM;">
    <div class="sidebar mt-3">
      <a href="/index.html">Home</a>
      <a href="/profile.html">Profile</a>
      <a href="/diary.html">Diary</a>
      <a href="/footprint.html">Footprint</a>
    </div>
  </div>

  <div class="container col-6">
    <div>
      <h3 class="text-center text-secondary mt-5 mb-5">æœå°‹é£Ÿç‰©ğŸ”</h3>
      <input type="text" id="autocomplete_search" class="form-control form-control-lg" style="margin: 40px 0 0 0;" />
      <span id="search_result"></span>
      <div class="text-end text-secondary mt-2">
        <p>æ‰¾ä¸åˆ°æƒ³è¦çš„é£Ÿç‰©å—ï¼Ÿ<a type="button" id="add_food">æŒ‰æ­¤å»ºç«‹</a></p>
      </div>
    </div>
    <div class="mt-5" style="border: #5d6c82 solid 2px; border-radius: 1em; padding: 2em;">
      <h4 class="text-center text-secondary mb-5">è¿‘æœŸç†±æœğŸ”¥</h4>
      <div id="food_trend" class="mt-3 mb-3" style="display: flex; flex-wrap:wrap; justify-content: space-between;">
      </div>
    </div>
    <div class="mb-6" id="hidden-div" style="display: none; height: 50px;"></div>
    <div class="text-center mt-5 mb-5" style="border: #5d6c82 solid 2px; border-radius: 1em; padding: 2em;" id="guess_title">
    <h4 class="text-secondary mb-5">çŒœä½ å–œæ­¡</h4>
    <div class="g-3" id="guess_user_preference">
      <!-- <div class="card text-center">
        <div style="padding:5px" class="card-header">
          <ul style="justify-content: end; align-items: center;" class="nav nav-pills">
            <li class="nav-item">
              <img src="/icons/thumb_up.png" class="click_icon" id="thumb_up">
            </li>
            <li class="nav-item">
              <img src="/icons/thumb_down.png" class="click_icon" id="thumb_down">
            </li>
            <li class="nav-item">
              <img src="/icons/empty_heart.webp" class="click_icon" id="add_collection">
            </li>
            <li class="nav-item">
              <img src="/icons/add.png" class="click_icon" id="add_diary">
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="row card-body-title">
            <div class="col-4"></div>
            <div class="col-8">
            <ul class="nav nav-pills">
              <li class="nav-card-title">
                <p class="text-secondary">ç†±é‡<br>kcal</br></p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">ç¢³æ°´åŒ–åˆç‰©</p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">è›‹ç™½è³ª</p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">è„‚è‚ª</p>
              </li>
            </ul>
            </div>
          </div>
          <div class="row card-body-title">
            <div class="col-4 text-secondary card-body-text">æ¼¢å ¡</div>
            <div class="col-8">
              <ul class="nav nav-pills">
                <li class="nav-card-title">
                  <p class="text-secondary">350</p>
                </li>
                <li class="nav-card-title">
                  <p class="text-secondary">80g</p>
                </li>
                <li class="nav-card-title">
                  <p class="text-secondary">12g</p>
                </li>
                <li class="nav-card-title">
                  <p class="text-secondary">8g</p>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div> -->
    </div>
    </div>
    </div>
  </div>
</main>

      
<div class="pop-background"></div>
    <div class="pop-window">
      <div class="pop-content">
        <form style="width: 23rem;">
          
          <h5 class="text-center text-secondary mb-6">å»ºç«‹é£Ÿç‰©æª”æ¡ˆ</h5>
          
            <div class="form-group row mt-4">
              <div class="col-4 text-secondary">é£Ÿç‰©å</div>
              <div class="col-7">
                <input type="text" id="name" class="form-control form-control-sm" />
              </div>
            </div>

            <div class="form-group row mt-3">
              <div class="col-4 text-secondary">æ¯ä»½é‡</div>
              <div class="col-4">
                <input type="number" min="1" max="1000" id="per_serving" class="form-control form-control-sm" />
              </div>
              <div class="col-1 text-secondary">g
              </div>
              <div class="col-4"></div>
              <div class="col-8 text-secondary mt-2"><p style="font-size: 12px">è‹¥ç„¡ç‰¹å®šä»½é‡ï¼Œå»ºè­°ä»¥100gç‚ºå–®ä½</p></div>
            </div>
            
            <div class="mt-2 mb-4 text-secondary">æ¯ä»½æ‰€å«ç‡Ÿé¤Šè³‡è¨Šï¼š<p style="font-size: 12px">è«‹å››æ¨äº”å…¥è‡³æ­£æ•´æ•¸</p></div>
            <!-- <div class="text-second ary mt-2"></div> -->

            <div class="form-group row mt-3">
              <div class="col-4 text-secondary">ç†±é‡</div>
              <div class="col-4">
                <input type="number" min="1" max="900" id="calories" class="form-control form-control-sm" />
              </div>
              <div class="col-1 text-secondary">kcal</div>
            </div>

            <div class="form-group row mt-3">
              <div class="col-4 text-secondary">ç¢³æ°´åŒ–åˆç‰©</div>
              <div class="col-4">
                <input min="0" type="number" id="carbs" class="form-control form-control-sm" />
              </div>
              <div class="col-1 text-secondary">g</div>
            </div>

            <div class="form-group row mt-3">
              <div class="col-4 text-secondary">è›‹ç™½è³ª</div>
              <div class="col-4">
                <input min="0" type="number" id="protein" class="form-control form-control-sm" />
              </div>
              <div class="col-1 text-secondary">g</div>
            </div>

            <div class="form-group row mt-3">
              <div class="col-4 text-secondary">è„‚è‚ª</div>
              <div class="col-4">
                <input min="0" type="number" id="fat" class="form-control form-control-sm" />
              </div>
              <div class="col-1 text-secondary">g</div>
            </div>
        
        </form>
        <div class="mt-4 mx-auto">
        <button type="button" class="btn-sm btn-outline-secondary mx-auto" id="submit_foodInfo">å»ºç«‹</button></div>
      </div>
    </div>

<div class="footer-dark">
  <footer>
      <div class="container">
          <div class="row">
              <div class="col-sm-6 col-md-3 item">
                  <h3>Services</h3>
                  <ul>
                      <li><a href="#">Web design</a></li>
                      <li><a href="#">Development</a></li>
                      <li><a href="#">Hosting</a></li>
                  </ul>
              </div>
              <div class="col-sm-6 col-md-3 item">
                  <h3>About</h3>
                  <ul>
                      <li><a href="#">Company</a></li>
                      <li><a href="#">Team</a></li>
                      <li><a href="#">Careers</a></li>
                  </ul>
              </div>
              <div class="col-md-6 item text">
                  <h3>BUFA FOOD</h3>
                  <p>Praesent sed lobortis mi. Suspendisse vel placerat ligula. Vivamus ac sem lacus. Ut vehicula rhoncus elementum. Etiam quis tristique lectus. Aliquam in arcu eget velit pulvinar dictum vel in justo.</p>
              </div>
              <!-- <div class="col item social"><a href="#"><i class="icon ion-social-facebook"></i></a><a href="#"><i class="icon ion-social-twitter"></i></a><a href="#"><i class="icon ion-social-snapchat"></i></a><a href="#"><i class="icon ion-social-instagram"></i></a></div> -->
          </div>
          <p class="copyright">BUFA FOOD Â© 2022</p>
      </div>
  </footer>
</div>

  <script>
  
  /* ç†±é–€é£Ÿç‰©æ’è¡Œæ¦œtop 5 */
  const foodTrendElement = document.getElementById('food_trend')
  async function getFoodTrendInfo() {
    const foodTrendInfo = await axios.get(`/api/1.0/food/trend`)
    // console.log('foodTrendInfo', foodTrendInfo);
    const foodTrend = foodTrendInfo.data.trendFood
    foodTrend.map(food =>
      foodTrendElement.innerHTML += `<a href="/detail.html?id=${food.food_id}" class="btn btn-outline-secondary">${food.name}</a>`
    )
  } 
  getFoodTrendInfo()

  /* çŒœä½ å–œæ­¡çš„ä¸‰æ¨£é£Ÿç‰© */
  const accessToken = window.localStorage.getItem('accessToken');
  const userId = window.localStorage.getItem('userId');

  if (!accessToken) {
    $('#guess_title').hide()
    $('#hidden-div').show()
  } else {
    const currentUserId = window.localStorage.getItem('userId');
    const guessUserElement = document.getElementById('guess_user_preference')
    async function getUserRecommendation(currentUserId) {
      const foodRecommendInfo = await axios.get(`/api/1.0/food/recommend?currentUserId=${currentUserId}`, { headers: { Authorization: `Bearer ${accessToken}` } })
      console.log('foodRecommendInfo', foodRecommendInfo);
      const foodRecommendation = foodRecommendInfo.data.foodNutritionInfo
      foodRecommendation.map(recommendation =>
      guessUserElement.innerHTML += `<a href="/detail.html?id=${recommendation.id}"><div class="card text-center"><div style="padding:5px" class="card-header"></div><div class="card-body"><div class="row card-body-title"><div class="col-5"></div><div class="col-7"><ul class="nav nav-pills"><li class="nav-card-title"><p class="text-secondary">ç†±é‡<br>kcal</br></p></li><li class="nav-card-title"><p class="text-secondary">ç¢³æ°´åŒ–åˆç‰©</p></li><li class="nav-card-title"><p class="text-secondary">è›‹ç™½è³ª</p></li><li class="nav-card-title"><p class="text-secondary">è„‚è‚ª</p></li></ul></div></div><div class="row card-body-title"><div class="col-5 text-secondary card-body-text">${recommendation.name}</div><div class="col-7"><ul class="nav nav-pills"><li class="nav-card-title"><p class="text-secondary">${recommendation.calories}</p></li><li class="nav-card-title"><p class="text-secondary">${recommendation.carbs}g</p></li><li class="nav-card-title"><p class="text-secondary">${recommendation.protein}g</p></li><li class="nav-card-title"><p class="text-secondary">${recommendation.fat}g</p></li></ul></div></div></div></a>`
      )
    } 
    getUserRecommendation(currentUserId)
  }

  function load_data(query) {
    fetch(`/api/1.0/food/search?key=${query}`)
    .then(function(response){
      return response.json();
    })
    .then(function(responseData){
      let html = '<ul class="list-group">';
      const len = responseData.length;
      if(len > 0) {
        for(let i = 0; i < len; i++) {
          // RegExp ç‰©ä»¶è¢«ç”¨ä¾†æ¯”å°ç¬¦åˆè‡ªè¨‚è¦å‰‡çš„æ–‡å­—
          let regular_expression = new RegExp(`(${query})`);
          // span ä¸­çš„$1è¡¨ç¤ºæœå°‹çš„é—œéµå­—
          html += `<a href="/detail.html?id=${responseData[i].id}" class="list-group-item list-group-item-action" onclick="get_text(this)">${responseData[i].name.replace(regular_expression, '<span class="text-secondary fw-bold">$1</span>')}</a>`;

          }
      } else {
        html += '<a href="#" class="list-group-item list-group-item-action disabled">No Data Found</a>';
      }
      html += '</ul>';
      document.getElementById('search_result').innerHTML = html;
    });
  }
  
  let search_element = document.getElementById("autocomplete_search");
  
  // è¿½è¹¤ä½¿ç”¨è€…è¼¸å…¥çš„å­—å…ƒï¼Œä¸¦åŸ·è¡Œquery
  search_element.onkeyup = function(){
    let query = search_element.value;
    load_data(query);
  };
  
  // // ä½¿ç”¨è€…åˆæ¬¡é»é¸inputä¾¿ç”¢ç”Ÿæ¨è–¦é …
  // search_element.onfocus = function(){
  //   let query = search_element.value;
  //   load_data(query);
  // };
  
  function get_text(event) {
    // console.log('event', event);
    let food_name = event.textContent;
    console.log(food_name);
    document.getElementById('autocomplete_search').value = food_name;
    document.getElementById('search_result').innerHTML = '';
  }
  
  /* é»é¸ æŒ‰æ­¤å»ºç«‹ æ™‚è·³å‡ºçš„å½ˆçª— */
  $('#add_food').click(function(){
    if (!accessToken) {
      Swal.fire({
      icon: 'warning',
      text: 'è«‹å…ˆç™»å…¥'
    })
    return
    }
    $('.pop-background').fadeIn(100);
    $('.pop-window').fadeIn(100);
  })
  $('.pop-background').click(function(){
    $('.pop-background').fadeOut(200);
    $('.pop-window').fadeOut(200);
  })

  $('#submit_foodInfo').click(async function(){
    const name = $('#name').val()
    let calories = $('#calories').val()
    let carbs = $('#carbs').val()
    let protein = $('#protein').val()
    let fat = $('#fat').val()
    calories = parseInt(calories)
    carbs = parseInt(carbs)
    protein = parseInt(protein)
    fat = parseInt(fat)
    let per_serving = $('#per_serving').val()
    per_serving = parseInt(per_serving)
    
    if(!name || !per_serving || !calories || !carbs || !protein || !fat){
      Swal.fire({
      icon: 'warning',
      text: 'å¡«å¯«è³‡è¨Šä¸å®Œæ•´'
    })
    return
    }

    if(calories < 1 || per_serving < 1){
      Swal.fire({
      icon: 'warning',
      text: 'è«‹ç¢ºèªä»½é‡è³‡è¨Š'
    })
    return
    }

    if((carbs + protein + fat) > per_serving){
      Swal.fire({
      icon: 'warning',
      text: 'è«‹ç¢ºèªç‡Ÿé¤Šç´ è³‡è¨Šå¡«å¯«æ˜¯å¦æ­£ç¢º'
    })
    return
    }

    /* å› ç†±é‡ä¾†æºæœ€é«˜ç‚ºè„‚è‚ª(1g = 9 kcal)ï¼Œæ•…ç†±é‡ç†ç•¶ä¸è©²è¶…éä»½é‡ä¸­ * 9 */
    if((carbs * 4 + protein * 4 + fat * 9) > calories || calories > per_serving * 9){
      Swal.fire({
      icon: 'warning',
      text: 'è«‹ç¢ºèªç†±é‡è³‡è¨Šå¡«å¯«æ˜¯å¦æ­£ç¢º'
    })
    return
    }

    // if (!Number.isInteger(per_serving) || !Number.isInteger(calories) || !Number.isInteger(protein) || !Number.isInteger(carbs) || !Number.isInteger(fat)){
    //   Swal.fire({
    //   icon: 'warning',
    //   text: 'è«‹è¼¸å…¥æ­£æ•´æ•¸'
    // })
    // return
    // }
    
    const data = await axios.post('/api/1.0/food/detail', { name, calories, carbs, protein, fat, per_serving }, { headers: { Authorization: `Bearer ${accessToken}` } })
    console.log('data: ', data);
    if (data.data.error) {
      Swal.fire({
        icon: 'warning',
        text: 'å»ºç«‹å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡'
      })
    } else if (data.data.message) {
      Swal.fire({
        icon: 'success',
        title: 'å»ºç«‹æˆåŠŸ',
        footer: '<a href="/mine.html" class="text-secondary">å‰å¾€æˆ‘çš„é£Ÿç‰©</a>'
      })
    }
  })
  
  </script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>
</body>
</html>