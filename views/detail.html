<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/detail.css">
  <link href="/icons/favicon.ico" rel="shortcut icon" type="image/ico" />
  <script src="https://kit.fontawesome.com/9d89bb6e53.js" crossorigin="anonymous"></script>
</head>
<body>
  <script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>
  <!-- <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <nav style="background-color: #495464;" class="navbar navbar-expand-xl navbar-dark" aria-label="Fourth navbar example">
    <div class="container-fluid">
      <a class="navbar-brand" href="/index.html"><img src="/images/bufafood_logo.png" class="brand-logo">  BUFA FOOD | ä¸ç™¼ç¦</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- æŠŠdivçš„ class="collapse navbar-collapse justify-content-md-end" æ‹¿æ‰ï¼Œå°±å¯ä»¥é”åˆ°ç½®å³å°é½Šäº† -->
      <div id="navbarsExample04">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link active" href="/search.html">é£Ÿç‰©åº«</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled">|</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/mine.html">æˆ‘çš„é£Ÿç‰©</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled">|</a>
          </li>
          <li class="nav-item">
            <a class="active" href="/profile.html"><img src="/icons/member-mobile.png"></a>
          </li>

        </ul>
      </div>
    </div>
  </nav>
  
  <main class="d-flex flex-nowrap container-color">
    <div class="flex-shrink-0 p-3 sidebar-custom sidebar-color" style="width: 13EM;">
    <div class="sidebar mt-3">
      <a href="/index.html">Home</a>
      <a href="/profile.html">Profile</a>
      <a href="/diary.html">Diary</a>
      <a href="/footprint.html">Footprint</a>
    </div>
  </div>
  
  <div class="pop-background"></div>
  <div class="pop-window">
    <div class="pop-content">
      <p class="text-secondary">æ–°å¢è‡³</p>
      <select style="margin: 5px 0;" class="custom-select col-8 text-secondary" id="inputGroupSelectMeal">
        <option selected>é¸é¤</option>
        <option value="1">æ—©é¤</option>
        <option value="2">åˆé¤</option>
        <option value="3">æ™šé¤</option>
        <option value="4">é»å¿ƒ</option>
      </select>
      <!-- <input class="datepicker"></input> -->
      <input style="margin: 5px 0 20px 0;" type="text" id="datepicker" class="form-control col-8 datepicker" placeholder="é¸æ—¥æœŸ">
      <p class="text-secondary">ä»½é‡(g)</p>
      <form class="form-horizontal" role="form">
        <div class="form-group">
            <div class="col-xs-2">
             <input type="number" id="serving_amount" min="1" class="form-control col-8" placeholder="è«‹è¼¸å…¥æ•¸å­—">
             <!-- TODO: æ˜¯å¦è©²è¨­ç½®ä¸Šé™ï¼Ÿ-->
            </div>
          </div>
      </form>
      <button type="button" class="btn btn-outline-secondary col-8" id="addMealRecord">æ–°å¢</button>
    </div>
  </div>

  <div class="container col-6 mt-4 mb-4">
      <div class="col-12 text-center mt-3" id="foodName"></div>
      <div class="card text-center">
        <div style="padding:5px" class="card-header">
          <ul style="justify-content: end; align-items: center;" class="nav nav-pills">
              <li class="nav-item" id="add_collection" onclick="updateInfo(this)">
                <!-- <img src="/icons/empty_heart.webp" class="click_icon" id="add_collection" onclick="updateInfo(this)"> -->
                <!-- <i onclick="updateInfo(this)" class="click_icon fa-regular fa-heart"></i> -->
              </li>
              <li class="nav-item" id="thumb_up" onclick="updateInfo(this)" >
                <!-- <img src="/icons/thumb_up.png" class="click_icon" onclick="updateInfo(this)"> -->
              </li>
            <li class="nav-item" id="thumb_down" onclick="updateInfo(this)" >
              <!-- <img src="/icons/thumb_down.png" class="click_icon"  onclick="updateInfo(this)"> -->
            </li>
            <li class="nav-item" id="add_exclusiion" onclick="updateInfo(this)" >
              <!-- <img src="/icons/nono.png" class="click_icon"  onclick="updateInfo(this)"> -->
            </li>
            <li class="nav-item" id="add_diary" onclick="updateInfo(this)" >
              <!-- <img src="/icons/add.png" class="click_icon" > -->
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="row card-body-title">
            <!-- <div class="col-4"></div> -->
            <div class="col-12">
            <ul class="nav nav-pills detail-card-body">
              <li class="nav-card-title">
                <p class="text-secondary">æ¯ä»½é‡</p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">ç†±é‡<br>kcal</br></p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">ç¢³æ°´åŒ–åˆç‰©</p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">è›‹ç™½è³ª</p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">è„‚è‚ª</p>
              </li>
            </ul>
            </div>
          </div>
          <div class="row card-body-title">
            <!-- <div class="col-4 text-secondary card-body-text"></div> -->
            <div class="col-12">
              <ul class="nav nav-pills detail-card-body">
                <li class="nav-card-title" id="foodServing">
                </li>
                <li class="nav-card-title" id="foodCalories">
                </li>
                <li class="nav-card-title" id="foodCarbs">
                </li>
                <li class="nav-card-title" id="foodProtein">
                </li>
                <li class="nav-card-title" id="foodFat">
                </li>
              </ul>
            </div>
          </div>
          <div class="row card-body-title">
            <div id="nutritionPie" style="width:100%; height:350px;"></div>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
</main>

<div class="footer-dark">
  <footer>
      <div class="container">
          <div class="row">
              <div class="col-sm-6 col-md-3 item">
                  <h3>Services</h3>
                  <ul>
                      <li><a href="#">Web design</a></li>
                      <li><a href="#">Development</a></li>
                      <li><a href="#">Hosting</a></li>
                  </ul>
              </div>
              <div class="col-sm-6 col-md-3 item">
                  <h3>About</h3>
                  <ul>
                      <li><a href="#">Company</a></li>
                      <li><a href="#">Team</a></li>
                      <li><a href="#">Careers</a></li>
                  </ul>
              </div>
              <div class="col-md-6 item text">
                  <h3>BUFA FOOD</h3>
                  <p>Praesent sed lobortis mi. Suspendisse vel placerat ligula. Vivamus ac sem lacus. Ut vehicula rhoncus elementum. Etiam quis tristique lectus. Aliquam in arcu eget velit pulvinar dictum vel in justo.</p>
              </div>
              <!-- <div class="col item social"><a href="#"><i class="fa-brands fa-facebook"></i></a><a href="#"><i class="icon ion-social-twitter"></i></a><a href="#"><i class="icon ion-social-snapchat"></i></a><a href="#"><i class="icon ion-social-instagram"></i></a></div> -->
          </div>
          <p class="copyright">BUFA FOOD Â© 2022</p>
      </div>
  </footer>
</div>

  <script>
  const userId = window.localStorage.getItem('userId');

  let accessToken = window.localStorage.getItem('accessToken');

  let webUrl = window.location.search;
  // console.log(webUrl);
  let splitUrl = webUrl.split('=');
  let foodId = splitUrl[1];
  if (!foodId) {
    window.location.href = `/search.html`
  }
  // console.log('foodId', foodId);
  getFoodDetail(foodId)

  async function getFoodDetail(foodId) {
    const detail = await axios.get(`/api/1.0/food/detail?id=${foodId}`)
    // console.log('detail', detail);
    if (detail.data.foodDetail.length === 0) {
      window.location.href = `/search.html`
    }
    const foodDetailInfo = detail.data.foodDetail[0]
    // console.log('foodDetailInfo', foodDetailInfo)
    $('#foodName').append (`<h4 class="text-secondary" id="food_name">${foodDetailInfo.name}</h4>`)
    $('#foodServing').append (`<p class="text-secondary">${foodDetailInfo.per_serving}g</p>`)
    $('#foodCalories').append (`<p class="text-secondary">${foodDetailInfo.calories}</p>`)
    $('#foodCarbs').append (`<p class="text-secondary">${foodDetailInfo.carbs}g</p>`)
    $('#foodProtein').append (`<p class="text-secondary">${foodDetailInfo.protein}g</p>`)
    $('#foodFat').append (`<p class="text-secondary">${foodDetailInfo.fat}g</p>`)
    const carbsPercentage = foodDetailInfo.carbs *4 /foodDetailInfo.calories
    const proteinPercentage = foodDetailInfo.protein *4 /foodDetailInfo.calories
    const fatPercentage = foodDetailInfo.fat *9 /foodDetailInfo.calories
    const pieData = [{
      values: [carbsPercentage, proteinPercentage, fatPercentage],
      labels: ['ç¢³æ°´åŒ–åˆç‰©', 'è›‹ç™½è³ª', 'è„‚è‚ª'],
      type: 'pie',
      marker: {
        colors: ['#607D8B', '#9E9E9E', '#EF9A9A']
      }
    }];
    pie = document.querySelector('#nutritionPie')
    Plotly.newPlot(pie, pieData);
  } 
  
  $(document).ready(async function(){
    if (!accessToken) {
      $('#add_collection').append('<i class="click_icon fa-regular fa-heart"></i>')
      $('#thumb_up').append('<i class="click_icon fa-regular fa-thumbs-up"></i>')
      $('#thumb_down').append('<i class="click_icon fa-regular fa-thumbs-down"></i>')
      $('#add_exclusiion').append('<i class="click_icon fa-regular fa-circle-xmark"></i>')
      $('#add_diary').append('<i class="click_icon fa-regular fa-calendar-plus"></i>')
    } else {
      $('#add_diary').append('<i class="click_icon fa-regular fa-calendar-plus"></i>')
      const data = await axios.get(`/api/1.0/user/preference?id=${userId}`, { headers: { Authorization: `Bearer ${accessToken}` } })
      // console.log('data', data);
      const preference = data.data.preference.filter(e => e.food_id == foodId)
      if (preference.length === 0){
        $('#add_collection').append('<i class="click_icon fa-regular fa-heart"></i>')
        $('#thumb_up').append('<i class="click_icon fa-regular fa-thumbs-up"></i>')
        $('#thumb_down').append('<i class="click_icon fa-regular fa-thumbs-down"></i>')
        $('#add_exclusiion').append('<i class="click_icon fa-regular fa-circle-xmark"></i>')
        return
      }
      if (preference[0].collection === 0) {
        $('#add_collection').append('<i class="click_icon fa-regular fa-heart"></i>')
      } else if(preference[0].collection === 1) {
        $('#add_collection').append('<i class="click_icon fa-solid fa-heart"></i>')
      }

      if (preference[0].likeIt === 0) {
        $('#thumb_up').append('<i class="click_icon fa-regular fa-thumbs-up"></i>')
      } else if(preference[0].likeIt === 1) {
        $('#thumb_up').append('<i class="click_icon fa-solid fa-thumbs-up"></i>')
      }
      if (preference[0].dislikeIt === 0) {
        $('#thumb_down').append('<i class="click_icon fa-regular fa-thumbs-down"></i>')
      } else if(preference[0].dislikeIt === 1) {
        $('#thumb_down').append('<i class="click_icon fa-solid fa-thumbs-down"></i>')
      }
      if (preference[0].exclusion === 0) {
        $('#add_exclusiion').append('<i class="click_icon fa-regular fa-circle-xmark"></i>')
      } else if(preference[0].exclusion === 1) {
        $('#add_exclusiion').append('<i class="click_icon fa-solid fa-circle-xmark"></i>')
      }
    }
  })

  $('.datepicker').datepicker({
  dateFormat: 'yy-mm-dd',
	forceParse: false,
  });

  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    icon: 'success',
    title: 'Your work has been saved',
    showConfirmButton: false,
    timer: 1500
  })


  // FIXME: æ‡‰è©²æ˜¯å› ç‚ºç”¨replaceWithçš„é—œä¿‚ï¼ŒæŒ‰éçš„æŒ‰éˆ•è‹¥æ²’é‡æ•´å°±ä¸èƒ½å†æŒ‰ä¸€æ¬¡äº†
  /* ç•¶æŒ‰ä¸‹å–œæ­¡ã€ä¸å–œæ­¡ã€ä¸åƒä»¥åŠæ”¶è—æŒ‰éˆ•æ™‚è§¸ç™¼ */
  async function updateInfo(iconBtn){
    const btnVal = $(iconBtn).attr('id')
    const foodName = document.querySelector('#food_name').textContent
    if (!accessToken) {
    Swal.fire({
      icon: 'warning',
      text: 'è«‹å…ˆç™»å…¥'
    })
    return
  }
    // console.log('foodName', foodName)
    // if(btnVal === 'add_collection'){
    switch (btnVal) {  
      case 'add_collection': {
        const data = await axios.get(`/api/1.0/user/preference?id=${userId}`, { headers: { Authorization: `Bearer ${accessToken}` } })
        // console.log('data', data);
        const collection = data.data.preference.filter(e => e.food_id == foodId)
        console.log('collection', collection)
        if (collection.length === 0 || collection[0].collection === 0) {
          const setPreference = await axios.patch(`/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal }, { headers: { Authorization: `Bearer ${accessToken}` } })
          $('#add_collection').replaceWith('<i class="click_icon fa-solid fa-heart"></i>')
          Toast.fire({
          icon: 'success',
          title: `å·²å°‡${foodName}åŠ å…¥æ”¶è—åˆ—è¡¨`,
          footer: `<a href="/mine.html" class="text-secondary">å‰å¾€æˆ‘çš„é£Ÿç‰©æ¸…å–®</a>`
        })
        } else if(collection[0].collection === 1) {
          const setPreference = await axios.patch(`/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal }, { headers: { Authorization: `Bearer ${accessToken}` } })
          $('#add_collection').replaceWith('<i class="click_icon fa-regular fa-heart"></i>')
          Toast.fire({
          icon: 'success',
          title: `å·²å°‡${foodName}å¾æ”¶è—åˆ—è¡¨ç§»é™¤`,
          footer: `<a href="/mine.html" class="text-secondary">å‰å¾€æˆ‘çš„é£Ÿç‰©æ¸…å–®</a>`
        })
        }
        break
      }
      case 'thumb_up': {
        const data = await axios.get(`/api/1.0/user/preference?id=${userId}`, { headers: { Authorization: `Bearer ${accessToken}` } })
        const likedItem = data.data.preference.filter(e => e.food_id == foodId)
        console.log('likedItem', likedItem)
        if (likedItem.length === 0 || likedItem[0].likeIt === 0) {
          const setPreference = await axios.patch(`/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal }, { headers: { Authorization: `Bearer ${accessToken}` } })
          $('#thumb_up').replaceWith('<i class="click_icon fa-solid fa-thumbs-up"></i>')
          $('#thumb_down').replaceWith('<i class="click_icon fa-regular fa-thumbs-down"></i>')
          $('#add_exclusiion').replaceWith('<i class="click_icon fa-regular fa-circle-xmark"></i>')
          Toast.fire({
          icon: 'success',
          title: `æˆ‘å–œæ­¡${foodName}ğŸ˜`
        })
        } else if(likedItem[0].likeIt === 1) {
          const setPreference = await axios.patch(`/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal }, { headers: { Authorization: `Bearer ${accessToken}` } })
          $('#thumb_up').replaceWith('<i class="click_icon fa-regular fa-thumbs-up"></i>')
          Toast.fire({
          icon: 'success',
          title: `æ”¶å›å°${foodName}çš„å–œæ­¡`
        })
        }
        break
      }
      case 'thumb_down': {
        const data = await axios.get(`/api/1.0/user/preference?id=${userId}`, { headers: { Authorization: `Bearer ${accessToken}` } })
        const dislikedItem = data.data.preference.filter(e => e.food_id == foodId)
        console.log('dislikedItem', dislikedItem)
        if (dislikedItem.length === 0 || dislikedItem[0].dislikeIt === 0) {
          const setPreference = await axios.patch(`/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal }, { headers: { Authorization: `Bearer ${accessToken}` } })
          $('#thumb_down').replaceWith('<i class="click_icon fa-solid fa-thumbs-down"></i>')
          $('#thumb_up').replaceWith('<i class="click_icon fa-regular fa-thumbs-up"></i>')
          Toast.fire({
          icon: 'success',
          title: `æˆ‘ä¸å–œæ­¡${foodName}ğŸ¤¢`
        })
        } else if(dislikedItem[0].dislikeIt === 1) {
          const setPreference = await axios.patch(`/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal }, { headers: { Authorization: `Bearer ${accessToken}` } })
          $('#thumb_down').replaceWith('<i class="click_icon fa-regular fa-thumbs-down"></i>')
          Toast.fire({
          icon: 'success',
          title: `æ”¶å›å°${foodName}çš„ä¸å–œæ­¡`
        })
        }
        break
      }
      case 'add_exclusiion': {
        const data = await axios.get(`/api/1.0/user/preference?id=${userId}`, { headers: { Authorization: `Bearer ${accessToken}` } })
        const exclusion = data.data.preference.filter(e => e.food_id == foodId)
        console.log('exclusion', exclusion)
        if (exclusion.length === 0 || exclusion[0].exclusion === 0) {
          const setPreference = await axios.patch(`/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal }, { headers: { Authorization: `Bearer ${accessToken}` } })
          $('#add_exclusiion').replaceWith('<i class="click_icon fa-solid fa-circle-xmark"></i>')
          $('#thumb_up').replaceWith('<i class="click_icon fa-regular fa-thumbs-up"></i>')
          Toast.fire({
          icon: 'success',
          title: `æˆ‘ä¸åƒ${foodName}ğŸ˜µ`,
          footer: `<a href="/mine.html" class="text-secondary">å‰å¾€æˆ‘çš„é£Ÿç‰©æ¸…å–®</a>`
        })
        } else if(exclusion[0].exclusion === 1) {
          const setPreference = await axios.patch(`/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal }, { headers: { Authorization: `Bearer ${accessToken}` } })
          $('#add_exclusiion').replaceWith('<i class="click_icon fa-regular fa-circle-xmark"></i>')
          Toast.fire({
          icon: 'success',
          title: `å°‡${foodName}å¾æŒ‘é£Ÿæ¸…å–®ä¸­ç§»é™¤`,
          footer: `<a href="/mine.html" class="text-secondary">å‰å¾€æˆ‘çš„é£Ÿç‰©æ¸…å–®</a>`
        })
        }
        break
      }
    }
  }

  // function updateInfo(iconBtn){
  // alert($(iconBtn).attr('id'))
  // }
  
  // $('#thumb_up').click(function() {
  //   const btn = $('#thumb_up').attr('id')
  //   alert('trigger worked!')
  // })  

  /* é»é¸ + æ™‚è·³å‡ºçš„å½ˆçª— */
  $('#add_diary').click(function(){
    if (!accessToken) {
    Swal.fire({
      icon: 'warning',
      text: 'è«‹å…ˆç™»å…¥'
    })
    return
  }
    $('.pop-background').fadeIn(100);
    $('.pop-window').fadeIn(100);
  })
  $('.pop-background').click(function(){
    $('.pop-background').fadeOut(200);
    $('.pop-window').fadeOut(200);
  })

  $('#addMealRecord').click(async function(){
    let meal = $('#inputGroupSelectMeal').val()
    meal = parseInt(meal)
    let servingAmount = $('#serving_amount').val()
    servingAmount = parseInt(servingAmount)
    const date = $('#datepicker').val()
    // console.log(foodId, meal,servingAmount, date);
    if (meal === 'é¸é¤') {
      Swal.fire({
      icon: 'error',
      title: 'è«‹é¸æ“‡è¦å»ºç«‹æ–¼å“ªä¸€é¤'
      })
      return
    } else if (!date) {
      Swal.fire({
      icon: 'error',
      title: 'è«‹é¸æ“‡è¦å»ºç«‹ä¹‹æ—¥æœŸ'
    })
      return
    } else if (!servingAmount || servingAmount < 1) {
      Swal.fire({
      icon: 'error',
      title: 'è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—'
    })
      return
    } else if (servingAmount > 500){
      Swal.fire(
        'çœŸçš„è¦åƒé€™éº¼å¤šå—ï¼Ÿè«‹æ³¨æ„ç‡Ÿé¤Šå‡è¡¡å–”ï½',
        'question'
      )
      return
    } else {
      await axios.post(`/api/1.0/food/mealrecord?id=${foodId}`, { userId, foodId, meal,servingAmount, date }, { headers: { Authorization: `Bearer ${accessToken}` } })
      Swal.fire({
      icon: 'success',
      title: 'æ–°å¢æˆåŠŸ',
      footer: `<a href="/diary.html?date=${date}" class="text-secondary">å‰å¾€${date}é£²é£Ÿç´€éŒ„</a>`
      })
    }
  })

  </script>
</body>
</html>
