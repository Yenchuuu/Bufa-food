<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/detail.css">
</head>
<body>
  <script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>
  <!-- <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <nav style="background-color: #4D555E;" class="navbar navbar-expand-md navbar-dark" aria-label="Fourth navbar example">
    <div class="container-fluid">
      <a class="navbar-brand" href="/index.html">BUFA FOOD | 不發福</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- 把div的 class="collapse navbar-collapse justify-content-md-end" 拿掉，就可以達到置右對齊了 -->
      <div id="navbarsExample04">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link active" href="/search.html">食物庫</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled">|</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/mine.html">我的食物</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled">|</a>
          </li>
          <li class="nav-item">
            <a class="active" href="/profile.html"><img src="/icons/member-mobile.png"></a>
          </li>

        </ul>
      </div>
    </div>
  </nav>
  
  <main class="d-flex flex-nowrap mt-4 mb-4">
  <div class="flex-shrink-0 p-3 sidebar-custom" style="width: 13EM;">
    <div class="sidebar">
      <a href="/index.html"><i class="fa fa-fw fa-home"></i> Home</a>
      <a href="/profile.html"><i class="fa fa-fw fa-wrench"></i> Profile</a>
      <a href="/diary.html"><i class="fa fa-fw fa-user"></i> Diary</a>
      <a href="/footprint.html"><i class="fa fa-fw fa-envelope"></i> Footprint</a>
    </div>
  </div>
  
  <div class="pop-background"></div>
  <div class="pop-window">
    <div class="pop-content">
      <p class="text-secondary">新增至</p>
      <select style="margin: 5px 0;" class="custom-select col-8 text-secondary" id="inputGroupSelectMeal">
        <option selected>選餐</option>
        <option value="1">早餐</option>
        <option value="2">午餐</option>
        <option value="3">晚餐</option>
        <option value="4">點心</option>
      </select>
      <!-- <input class="datepicker"></input> -->
      <input style="margin: 5px 0 20px 0;" type="text" id="datepicker" class="form-control col-8 datepicker" placeholder="選日期">
      <p class="text-secondary">份量(g)</p>
      <form class="form-horizontal" role="form">
        <div class="form-group">
            <div class="col-xs-2">
             <input type="number" id="serving_amount" min="1" class="form-control col-8" placeholder="請輸入數字">
             <!-- TODO: 是否該設置上限？-->
            </div>
          </div>
      </form>
      <button type="button" class="btn btn-outline-secondary col-8" id="addMealRecord">新增</button>
    </div>
  </div>

  <div class="container col-6 mt-4 mb-4">
      <div class="col-12 text-center" id="foodName"></div>
      <div class="card text-center">
        <div style="padding:5px" class="card-header">
          <ul style="justify-content: end; align-items: center;" class="nav nav-pills">
              <li class="nav-item">
                <img src="/icons/empty_heart.webp" class="click_icon" id="add_collection" onclick="updateInfo(this)">
              </li>
              <li class="nav-item">
                <img src="/icons/thumb_up.png" class="click_icon" id="thumb_up" onclick="updateInfo(this)">
              </li>
            <li class="nav-item">
              <img src="/icons/thumb_down.png" class="click_icon" id="thumb_down" onclick="updateInfo(this)">
            </li>
            <li class="nav-item">
              <img src="/icons/nono.png" class="click_icon" id="add_exclusiion" onclick="updateInfo(this)">
            </li>
            <li class="nav-item">
              <img src="/icons/add.png" class="click_icon" id="add_diary">
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="row card-body-title">
            <!-- <div class="col-4"></div> -->
            <div class="col-12">
            <ul class="nav nav-pills detail-card-body">
              <li class="nav-card-title">
                <p class="text-secondary">每份量</p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">熱量<br>kcal</br></p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">碳水化合物</p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">蛋白質</p>
              </li>
              <li class="nav-card-title">
                <p class="text-secondary">脂肪</p>
              </li>
            </ul>
            </div>
          </div>
          <div class="row card-body-title">
            <!-- <div class="col-4 text-secondary card-body-text"></div> -->
            <div class="col-12">
              <ul class="nav nav-pills detail-card-body">
                <li class="nav-card-title" id="foodServing">
                </li>
                <li class="nav-card-title" id="foodCalories">
                </li>
                <li class="nav-card-title" id="foodCarbs">
                </li>
                <li class="nav-card-title" id="foodProtein">
                </li>
                <li class="nav-card-title" id="foodFat">
                </li>
              </ul>
            </div>
          </div>
          <div class="row card-body-title">
            <div id="nutritionPie" style="width:100%; height:350px;"></div>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
</main>

<div class="footer-dark">
  <footer>
      <div class="container">
          <div class="row">
              <div class="col-sm-6 col-md-3 item">
                  <h3>Services</h3>
                  <ul>
                      <li><a href="#">Web design</a></li>
                      <li><a href="#">Development</a></li>
                      <li><a href="#">Hosting</a></li>
                  </ul>
              </div>
              <div class="col-sm-6 col-md-3 item">
                  <h3>About</h3>
                  <ul>
                      <li><a href="#">Company</a></li>
                      <li><a href="#">Team</a></li>
                      <li><a href="#">Careers</a></li>
                  </ul>
              </div>
              <div class="col-md-6 item text">
                  <h3>BUFA FOOD</h3>
                  <p>Praesent sed lobortis mi. Suspendisse vel placerat ligula. Vivamus ac sem lacus. Ut vehicula rhoncus elementum. Etiam quis tristique lectus. Aliquam in arcu eget velit pulvinar dictum vel in justo.</p>
              </div>
              <div class="col item social"><a href="#"><i class="icon ion-social-facebook"></i></a><a href="#"><i class="icon ion-social-twitter"></i></a><a href="#"><i class="icon ion-social-snapchat"></i></a><a href="#"><i class="icon ion-social-instagram"></i></a></div>
          </div>
          <p class="copyright">BUFA FOOD © 2022</p>
      </div>
  </footer>
</div>

  <script>
  let webUrl = window.location.search;
  // console.log(webUrl);
  let splitUrl = webUrl.split('=');
  let foodId = splitUrl[1];
  if (!foodId) {
    window.location.href = `http://${location.host}/search.html`
  }
  // console.log('foodId', foodId);
  getFoodDetail(foodId)

  async function getFoodDetail(foodId) {
    const detail = await axios.get(`http://${location.host}/api/1.0/food/detail?id=${foodId}`)
    // console.log('detail', detail);
    if (detail.data.foodDetail.length === 0) {
      window.location.href = `http://${location.host}/search.html`
    }
    const foodDetailInfo = detail.data.foodDetail[0]
    // console.log('foodDetailInfo', foodDetailInfo)
    $('#foodName').append (`<h4 class="text-secondary" id="food_name">${foodDetailInfo.name}</h4>`)
    $('#foodServing').append (`<p class="text-secondary">${foodDetailInfo.per_serving}g</p>`)
    $('#foodCalories').append (`<p class="text-secondary">${foodDetailInfo.calories}</p>`)
    $('#foodCarbs').append (`<p class="text-secondary">${foodDetailInfo.carbs}g</p>`)
    $('#foodProtein').append (`<p class="text-secondary">${foodDetailInfo.protein}g</p>`)
    $('#foodFat').append (`<p class="text-secondary">${foodDetailInfo.fat}g</p>`)
    const carbsPercentage = foodDetailInfo.carbs *4 /foodDetailInfo.calories
    const proteinPercentage = foodDetailInfo.protein *4 /foodDetailInfo.calories
    const fatPercentage = foodDetailInfo.fat *9 /foodDetailInfo.calories
    const pieData = [{
      values: [carbsPercentage, proteinPercentage, fatPercentage],
      labels: ['碳水化合物', '蛋白質', '脂肪'],
      type: 'pie',
      marker: {
        colors: ['#607D8B', '#9E9E9E', '#EF9A9A']
      }
    }];
    pie = document.querySelector('#nutritionPie')
    Plotly.newPlot(pie, pieData);
  } 
  
  $('.datepicker').datepicker({
  dateFormat: 'yy-mm-dd',
	forceParse: false,
  });

  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener('mouseenter', Swal.stopTimer)
      toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
  })
  /* 當按下喜歡、不喜歡、不吃以及收藏按鈕時觸發 */
  async function updateInfo(iconBtn){
    // TODO: user id 改成localstorage
    let userId = 20
    const btnVal = $(iconBtn).attr('id')
    const foodName = document.querySelector('#food_name').textContent
    // console.log('foodName', foodName)
    // if(btnVal === 'add_collection'){
    switch (btnVal) {  
      case 'add_collection': {
        const data = await axios.get(`http://${location.host}/api/1.0/user/mine?id=${userId}`)
        const collection = data.data.preference.filter(e => e.food_id == foodId)[0].collection
        console.log('collection', collection)
        if (collection.length === 0 || collection === 0) {
          const setPreference = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal })
          Toast.fire({
          icon: 'success',
          title: `已將${foodName}加入收藏列表`,
          footer: `<a href="/mine.html" class="text-secondary">前往我的食物清單</a>`
        })
        } else if(collection === 1) {
          const setPreference = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal })
          Toast.fire({
          icon: 'success',
          title: `已將${foodName}從收藏列表移除`,
          footer: `<a href="/mine.html" class="text-secondary">前往我的食物清單</a>`
        })
        }
        break
      }
      case 'thumb_up': {
        const data = await axios.get(`http://${location.host}/api/1.0/user/mine?id=${userId}`)
        const likedItem = data.data.preference.filter(e => e.food_id == foodId)[0].likeIt
        console.log('likedItem', likedItem)
        if (likedItem.length === 0 || likedItem === 0) {
          const setPreference = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal })
          Toast.fire({
          icon: 'success',
          title: `我喜歡${foodName}😍`
        })
        } else if(likedItem === 1) {
          const setPreference = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal })
          Toast.fire({
          icon: 'success',
          title: `收回對${foodName}的喜歡`
        })
        }
        break
      }
      case 'thumb_down': {
        const data = await axios.get(`http://${location.host}/api/1.0/user/mine?id=${userId}`)
        const dislikedItem = data.data.preference.filter(e => e.food_id == foodId)[0].dislikeIt
        console.log('dislikedItem', dislikedItem)
        if (dislikedItem.length === 0 || dislikedItem === 0) {
          const setPreference = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal })
          Toast.fire({
          icon: 'success',
          title: `我不喜歡${foodName}🤢`
        })
        } else if(dislikedItem === 1) {
          const setPreference = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal })
          Toast.fire({
          icon: 'success',
          title: `收回對${foodName}的不喜歡`
        })
        }
        break
      }
      case 'add_exclusiion': {
        const data = await axios.get(`http://${location.host}/api/1.0/user/mine?id=${userId}`)
        const exclusion = data.data.preference.filter(e => e.food_id == foodId)[0].exclusion
        console.log('exclusion', exclusion)
        if (exclusion.length === 0 || exclusion === 0) {
          const setPreference = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal })
          Toast.fire({
          icon: 'success',
          title: `我不吃${foodName}😵`,
          footer: `<a href="/mine.html" class="text-secondary">前往我的食物清單</a>`
        })
        } else if(exclusion === 1) {
          const setPreference = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, { clickedBtn: btnVal })
          Toast.fire({
          icon: 'success',
          title: `將${foodName}從挑食清單中移除`,
          footer: `<a href="/mine.html" class="text-secondary">前往我的食物清單</a>`
        })
        }
        break
      }
    }
  }

  // function updateInfo(iconBtn){
  // alert($(iconBtn).attr('id'))
  // }
  
  // $('#thumb_up').click(function() {
  //   const btn = $('#thumb_up').attr('id')
  //   alert('trigger worked!')
  // })  
  // $('#thumb_down').click(function() {
  //   alert('trigger worked!')
  // })  
  // $('#add_collection').click(function() {
  //   alert('trigger worked!')
  // })
  // $('#add_diary').click(function() {
  //   alert('trigger worked!')
  // })

  /* 點選 + 時跳出的彈窗 */
  $('#add_diary').click(function(){
    $('.pop-background').fadeIn(100);
    $('.pop-window').fadeIn(100);
  })
  $('.pop-background').click(function(){
    $('.pop-background').fadeOut(200);
    $('.pop-window').fadeOut(200);
  })

  // TODO: get user_id from localStorage
  $('#addMealRecord').click(async function(){
    const meal = $('#inputGroupSelectMeal').val()
    const servingAmount = $('#serving_amount').val()
    const date = $('#datepicker').val()
    // console.log(foodId, meal,servingAmount, date);
    if (meal === '選餐') {
      Swal.fire({
      icon: 'error',
      title: '請選擇要建立於哪一餐'
      })
      return
    } else if (!date) {
      Swal.fire({
      icon: 'error',
      title: '請選擇要建立之日期'
    })
      return
    } else if (!servingAmount || servingAmount < 1) {
      Swal.fire({
      icon: 'error',
      title: '請輸入有效數字'
    })
      return
    } else if (servingAmount > 500){
      Swal.fire(
        '真的要吃這麼多嗎？請注意營養均衡喔～',
        'question'
      )
      return
    } else {
      await axios.post(`http://${location.host}/api/1.0/food/create?id=${foodId}`, { userId: 20, foodId, meal,servingAmount, date })
      Swal.fire({
      icon: 'success',
      title: '新增成功',
      footer: `<a href="/diary.html?date=${date}" class="text-secondary">前往${date}飲食紀錄</a>`
      })
    }
  })

  // $('#add_collection').click(async function() {
  //   
  //   let userId = 20
  //   const data = await axios.get(`http://${location.host}/api/1.0/food/mine?id=${userId}`)
  //   const collection = data.data.preference.filter(e => e.collection)
  //   if (collection === 0) {
  //     $('#add_collection').html('<img src="/icons/full_heart.webp" class="click_icon" id="add_collection">')
  //   }
  //   Swal.fire({
  //     icon: 'success',
  //     title: '新增成功'
  //   })
  // })

  // 更新資料
  // async function updatepreference(foodId) {
  //   try {
  //     switch (btnId) {
  //       case 'thumb_up': btnValue = 
  //     }

  //     const data = { preference: `${btnValue}` }
  //     const updateInfo = await axios.patch(`http://${location.host}/api/1.0/food/detail?id=${foodId}`, data)
  //     console.log();
  //   } catch (err) {
  //     console.log(err)
  //   }
  // }

  </script>
</body>
</html>
